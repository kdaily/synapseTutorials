---
title: "Synapse Tables - Changing a Column"
author: "Kenneth Daily"
date: "01/23/2015"
output: html_document
---

An example of changing a column type, keeping the same data.

First, set the column name that you want to change, and the table it comes from.

```{r libs}
library(synapseClient)
synapseLogin()
```


```{r}
columnToChange <- "name"
tableId <- "syn3079803"
```

Get the existing data.

```{r}
## Get the existing data
oldTable <- synGet(tableId)
oldDataQuery <- synTableQuery(sprintf("SELECT * FROM %s", oldTable$properties$id))
oldData <- oldDataQuery@values
```

Now that you have the data, delete the column. The `newTable` is now without that column.

```{r}
collist <- setNames(oldTable$properties$columnIds, names(oldDataQuery@values))

oldTable$properties$columnIds <- setdiff(oldTable$properties$columnIds, collist[columnToChange])

newTable <- synStore(oldTable)
```

Make a new column with same name and save it to Synapse. In this case I'm just changing the maximum size.

```{r}
newcol <- TableColumn(name=columnToChange, columnType="STRING", maximumSize=50, defaultValue="")
newcol <- synStore(newcol)
```

Add that column to the table and save:

```{r}

newTable$properties$columnIds <- c(newTable$properties$columnIds, newcol@id)
newTable <- synStore(newTable)

```

Now, make changes and save to Synapse. In this case I just copy the old data to the new column.

```{r}
newQuery <- synTableQuery(sprintf("SELECT * FROM %s", newTable$properties$id))
newQuery@values[columnToChange] <- oldData[columnToChange]

## Commit the changes
synStore(newQuery)
```

All of this can go into a function:

```{r}

changeColumn <- function(tableId, columnToChange, newColumn) {
  # Reqiures:
  # Synapse ID for the table
  # the name of the column to change
  # a column that has already been saved to Synapse
  
  oldTable <- synGet(tableId)
  oldDataQuery <- synTableQuery(sprintf("SELECT * FROM %s", oldTable$properties$id))
  oldData <- oldDataQuery@values
  
  collist <- setNames(oldTable$properties$columnIds, names(oldDataQuery@values))
  oldTable$properties$columnIds <- setdiff(oldTable$properties$columnIds, collist[columnToChange])
  synStore(oldTable)

  newTable <- synGet(tableId)

  newTable$properties$columnIds <- c(newTable$properties$columnIds, newcol@id)
  newTable <- synStore(newTable)

  newTable$properties$columnIds <- c(newTable$properties$columnIds, newColumn@id)
  newTable <- synStore(newTable)

  newQuery <- synTableQuery(sprintf("SELECT * FROM %s", newTable$properties$id))
  newQuery@values[columnToChange] <- oldData[columnToChange]
  
  ## Commit the changes
  synStore(newQuery)

  }

```

Now, the change is as such:

```{r}
newcol <- TableColumn(name=columnToChange, columnType="STRING", maximumSize=100, defaultValue="")
newcol <- synStore(newcol)

newData <- changeColumn(tableId=tableId, columnToChange=columnToChange, newColumn=newcol)
```

